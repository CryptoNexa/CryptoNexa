{% block cryptoListView %}
    <div class="container">
        {% if error_message %}
            <h1>{{ error_message }}</h1>
        {% else %}
            <table class="table table-striped">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Price {{ session_cur }}</th>
                    <th>1h%</th>
                    <th>24h%</th>
                    <th>MarketCap</th>
                    <th>Volume (24h)</th>
                </tr>
                </thead>
                <tbody id="crypto-table-body">
                {% for crypto in cryptos %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td><a href="{% url 'core:crypto_detail' crypto.slug %}">{{ crypto.name }}</a></td>
                        <td id="price-{{ crypto.id }}">{{ crypto.price }}</td>
                        <td id="change-1h-{{ crypto.id }}"
                            class="{% if crypto.percent_change_1h < 0 %}text-danger{% elif crypto.percent_change_1h > 0 %}text-success{% else %}text-muted{% endif %}">
                            {{ crypto.percent_change_1h }}
                        </td>
                        <td id="change-24h-{{ crypto.id }}"
                            class="{% if crypto.percent_change_24h < 0 %}text-danger{% elif crypto.percent_change_24h > 0 %}text-success{% else %}text-muted{% endif %}">
                            {{ crypto.percent_change_24h }}
                        </td>
                        <td id="market-cap-{{ crypto.id }}">${{ crypto.market_cap }}</td>
                        <td id="volume-24h-{{ crypto.id }}">${{ crypto.volume_24h }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% endif %}

    </div>

    {% if not error_message %}
            <script>
                function updateCryptoData() {
                    fetch('{% url 'core:get_updated_crypto_data' fetch_live_data=0 %}')
                        .then(response => response.json())
                        .then(data => {
                            data.forEach(crypto => {
                                const cryptoId = crypto.id;

                                document.getElementById(`price-${cryptoId}`).innerText = `$${crypto.price}`;
                                document.getElementById(`change-1h-${cryptoId}`).innerText = crypto.percent_change_1h;
                                document.getElementById(`change-24h-${cryptoId}`).innerText = crypto.percent_change_24h;
                                document.getElementById(`market-cap-${cryptoId}`).innerText = `$${crypto.market_cap}`;
                                document.getElementById(`volume-24h-${cryptoId}`).innerText = `$${crypto.volume_24h}`;
                                document.getElementById(`change-1h-${cryptoId}`).classList = calculateChangeClass(crypto.percent_change_1h);
                                document.getElementById(`change-24h-${cryptoId}`).classList = calculateChangeClass(crypto.percent_change_24h);
                            });
                        })
                        .catch(error => {
                            console.error('Error fetching crypto data:', error);
                        });
                }

                function calculateChangeClass(change) {
                    if (change < 0) {
                        return 'text-danger';
                    } else if (change > 0) {
                        return 'text-success';
                    } else {
                        return 'text-muted';
                    }
                }

                setInterval(updateCryptoData, 10000); // Update crypto data every 10 seconds (10000 milliseconds)
                updateCryptoData(); // Initially load the crypto data
            </script>
    {% endif %}

{% endblock %}
